var fe=Object.defineProperty,ge=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var A=(t,e,s)=>e in t?fe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,r=(t,e)=>{for(var s in e||(e={}))pe.call(e,s)&&A(t,s,e[s]);if(j)for(var s of j(e))ve.call(e,s)&&A(t,s,e[s]);return t},m=(t,e)=>ge(t,he(e));var w=(t,e,s)=>(A(t,typeof e!="symbol"?e+"":e,s),s);import{W as y,d as be,t as f,p as g,m as c,A as we,E as ye,H as Ee,a as k,v as _e,i as De,b as P,s as Oe,c as V,e as U,f as Se,r as Ce,g as I,h as W,j as Me,k as B,l as $,n as Te,o as Ae,z as ke,M as Ie,q as Y,u as Le,w as Ge,x as Re,y as xe,F as h,B as L,C as p,D as Fe,G as ze}from"./vendor.bc17363a.js";const Ne=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerpolicy&&(n.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?n.credentials="include":o.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=s(o);fetch(o.href,n)}};Ne();const He="route-to",Ke="toggle-debug",_="toggle-key-state",E="set-key-state",Z="reset-key-state",q="set-random-key-state",G="set-highlights",X="reset-highlights",J="set-size",Q="toggle-view-config",ee="set-midi-devices",v="set-midi-file",te="set-midi-file-error",je="set-comparison",se=t=>{y.inputs.forEach(e=>e.addListener("noteon","all",s=>{t.dispatch([_,s.note.number%12]),console.log(`Received 'noteon' message (${s.note.name+s.note.octave}) from ${e.name}`)}))},Pe=t=>{y.enable(e=>{if(e){console.log("WebMidi could not be enabled.",e);return}else console.log("WebMidi enabled!"),t.dispatch([ee,y.inputs.map(s=>s.name)]);se(t)})},Ve=(t,e)=>{if(y.inputs.forEach(s=>s.removeListener()),e==="All Devices"){se(t);return}else{const s=y.getInputByName(e);s&&s.addListener("noteon","all",i=>{t.dispatch([_,i.note.number%12]),console.log(`Received 'noteon' message (${i.note.name+i.note.octave}) from ${e}`)})}},Ue=t=>{const e=t.views,s=t.ui.midiDevicesStatus,i=t.bus;return()=>{const o=e.enabledMidi.deref();let n=e.midiDevices.deref();return["div",["span",s.content[Number(o)],""],["span",s.dropdown.root,n.length>=1?[be,m(r({},s.dropdown.selection),{onchange:a=>Ve(i,a.target.value)}),f(c(a=>[a,a]),g(),["All Devices",...n])]:"Web MIDI unavailable"]]}},oe="route-to";class We{constructor(e){w(this,"config");w(this,"ctx");w(this,"state");w(this,"router");this.config=e,this.state=new we(e.initialState||{}),this.ctx={bus:new ye(this.state,e.events,e.effects),views:{},ui:e.ui},this.addViews(this.config.views),this.router=new Ee(e.router),this.router.addListener(k,s=>this.ctx.bus.dispatch([k,s.value])),this.ctx.bus.addHandlers({[k]:_e("route"),[He]:(s,[i,o])=>({[oe]:o})}),this.ctx.bus.addEffect(oe,([s,i])=>this.router.routeTo(this.router.format(s,i))),this.addViews({route:"route",routeComponent:["route.id",s=>(this.config.components[s]||(()=>["div",`missing component for route: ${s}`]))(this.ctx)]})}addViews(e){const s=this.ctx.views;for(let i in e){const o=e[i];s[i]=De(o)?P(this.state,o[0],o[1]):P(this.state,o)}}start(){Pe(this.ctx.bus),window.addEventListener("resize",()=>{this.ctx.bus.dispatch([J])}),this.router.start(),Oe(()=>{if(this.ctx.bus.processQueue())return this.rootComponent()},{root:this.config.domRoot,ctx:this.ctx})}rootComponent(){this.ctx.views.debug.deref();const e=this.ctx.ui;return["div",e.root,["div",this.ctx.views.routeComponent]]}}const ie=(t,e,s={})=>(i,o)=>["a",m(r({},s),{onclick:t,disabled:o}),e],Be=t=>{const e=t.ui,s=ie(o=>{o.preventDefault(),t.bus.dispatch([Z])},"CLEAR",e.toolbar.button),i=ie(o=>{o.preventDefault(),t.bus.dispatch([q])},"RANDOM",e.toolbar.button);return()=>["div",e.toolbar.root,[s],[i]]},$e={anim:100,pad:1,margin:0,hlOn:{fill:"#E83015"},bgOn:{fill:"#CCCCCC"},bgOff:{fill:"#CCCCCC"},fgOn:{fill:"#E83015"},fgOff:{fill:"#fff"},floor:1},Ye=["filter",{id:"blur"},["feGaussianBlur",{in:"SourceGraphic",stdDeviation:".25"}]],R=(t={})=>{const e=r(r({r:5},$e),t),{r:s,pad:i,margin:o,glyph:n,floor:a}=e,l=.5,u=s*l**2,d=o*2,b=s+i,z=b+o,S=b*2+d,re={width:S,height:S*a},C={transition:`all ${e.anim}ms ease-out`},M={cx:z,cy:z},ae=m(r(r({},e.hlOn),M),{r:b}),N=m(r(r({},e.bgOn),M),{style:C,r:s}),le=r(r({},N),e.bgOff),H=m(r(r({},e.fgOn),M),{style:C,r:u}),ce=r(r({},H),e.fgOff),K=m(r({},e.fgOn),{x:"50%",y:"50%","text-anchor":"middle","alignment-baseline":"central",font:"bold font-sans","font-size":S*l,style:C}),de=r(r({},K),e.fgOff);return(wt,ue,T,me)=>["svg",r(r({},re),ue),Ye,["g",["circle",me?ae:{}],["circle",T?N:le],n?["text",T?K:de,n]:["circle",T?H:ce]]]},x={anim:0,r:16,pad:2},Ze=m(r({},x),{glyph:"C"}),qe=m(r({},x),{bgOn:{fill:"#000"},bgOff:{fill:"#000"}}),Xe=(t,e)=>[1,3,6,8,10].includes(t)?e.minor:t===4?e.e:e.major,Je=t=>{const e=t.views,s=t.ui,i=e.size.deref(),o=Math.min(18*2,i[0]*.9/13),n={r:o/2*(8/9),pad:o/2*(1/9)},a=e.highlights.deref();return["div.mb-4",...e.keyState.deref().map((l,u)=>["div",Xe(u,s.toggleGroup.key),[u===0?R(r(r({},Ze),n)):[2,4,5,7,9,11].includes(u)?R(r(r({},x),n)):R(r(r({},qe),n)),{onclick:d=>{d.preventDefault(),t.bus.dispatch([_,u])}},l,a.includes(u)]])]},Qe=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],et=f(c(t=>Me(t)),g(),Qe),ne=f(V({raw:c(t=>t),tonicMidi:c(t=>U(t.tonic+"2")%12),majorKey:c(t=>t.tonic),minorKey:c(t=>Se(t.minorRelative).toLowerCase()),normalizedMidis:c(t=>f(c(e=>U(e+"2")%12),g(),t.scale))}),g(),et),tt=t=>{const e=f($(c(o=>t[o]?o:null),Te(o=>o!==null)),g(),B(12)),s=f($(c(o=>Ae(new Set(o.normalizedMidis),new Set(e))),c(o=>Array.from(o))),g(),ne);let i=f(V({majorKey:c(o=>o[0].majorKey),minorKey:c(o=>o[0].minorKey),normalizedMidis:c(o=>o[0].normalizedMidis),common:c(o=>o[1]),similarity:c(o=>o[1].length/e.length+(e.includes(o[0].tonicMidi)?.1:0))}),g(),ke(ne,s));return i=i.sort((o,n)=>n.similarity-o.similarity),i},D=[...Ce(!1,12)];[...I(12,W([!0,!1],[.5,.5]))];const st=t=>{let s=new Ie(t).tracks;s.sort((n,a)=>a.notes.length-n.notes.length);const i=s[0],o=f(c(n=>n[0]%12),g(),I(7,Y(i.notes.map(n=>n.midi))));return Array.from(new Set(o))},ot=()=>{try{return new AudioContext}catch{return new window.webkitAudioContext}},it=async(t,e)=>{try{return await t.decodeAudioData(e)}catch{return new Promise((s,i)=>{t.decodeAudioData(e,s,i)})}},nt=t=>Math.pow(2,Math.round(Math.log(t)/Math.log(2))),rt=async t=>{const e=1,s=ot(),i=await it(s,t),o=i.getChannelData(0),n=nt(i.sampleRate/e),a=Math.floor(o.length/n),l=f(c(d=>Le.extract("chroma",o.slice(d*n,(d+1)*n))),g(),B(a)),u=f(c(d=>d.indexOf(1)),g(),l);return f(c(d=>d[0]),g(),f(c(d=>d),g(),Y(u)).sort((d,b)=>b[1]-d[1])).slice(0,7)},at=(t,e)=>{const i=t.views.viewConfig.deref();return["div.flex",["div",e.majorKey,i.showSmall?["small"," maj"]:[]],i.showMinor?["div",["span.text-red-600"," \u30FB "],e.minorKey,i.showSmall?["small"," min"]:[]]:[]]},lt=(t,e)=>{const i=t.views.size.deref(),o=Math.min(400*1.1,i[0]*.9),n=.1,a=35,l={width:o,height:o/a,rx:5,fill:"#e2e2e2"};return["div",["svg",{width:o*(1+n),height:o/a},["g",["rect",l],e.common.length>0?["rect",m(r({},l),{width:(e.similarity-n)*o,fill:"#000"})]:[]]]]},ct=t=>{const e=t.views,s=t.ui,i=tt(e.keyState.deref());return["div",s.keyGroup.root,...i.map((o,n)=>["div",m(r({},s.keyGroup.block),{onmouseover:a=>{a.preventDefault(),t.bus.dispatch([G,o.normalizedMidis])},onmouseleave:a=>{a.preventDefault(),t.bus.dispatch([X])}}),[at,o],[lt,o]])]},O=t=>{t.preventDefault()},dt=(t,e)=>{O(e);const s=e.dataTransfer.files;if(s&&s.length>0){const i=new FileReader,o=s[0];i.onload=async n=>{if(o.type==="audio/midi"){t.dispatch([v,o.name]);const a=st(n.target.result);t.dispatch([E,D.map((l,u)=>!!a.includes(u))])}else if(o.type==="audio/aac"||o.type==="audio/mpeg"||o.type==="audio/wav"){t.dispatch([v,o.name]);const a=await rt(n.target.result);t.dispatch([E,D.map((l,u)=>!!a.includes(u))])}else t.dispatch([te])},i.readAsArrayBuffer(o)}},ut=t=>{const e=t.bus,s=t.views,i=t.ui.fileDropZone,o=s.midiFile.deref(),n=s.size.deref(),a=Math.min(400*1.1,n[0]*.9);return["div",m(r({},i.root),{ondrop:l=>{l.target.classList.remove("nm-inset-gray-200-sm"),dt(e,l)},ondragenter:l=>{l.target.classList.add("nm-inset-gray-200-sm"),O(l)},ondragleave:l=>{l.target.classList.remove("nm-inset-gray-200-sm"),O(l)},ondragover:l=>O(l),style:{width:`${a}px`}}),o]},mt={w:16,h:8,pad:2,margin:0},ft=Ge(m(r({},mt),{vertical:!1})),gt=t=>{const e=t.views,s=t.ui.viewConfigToggleGroup,i=e.viewConfig.deref();return["div",Object.entries(i).map(([o,n])=>["div",s.block,[ft,{onclick:()=>t.bus.dispatch([Q,o])},n],["span",s.caption,o]])]},ht=Re({element:"h2",attribs:{class:"text-2xl font-extrabold mb-4"}}),pt=t=>()=>["div",[ht,"OP-Z KEY FINDER"],["div.pb-4",Ue],["div.pb-4",Be],["div.mb-4",[Je],[ct]],[ut],["div.block",["details",["summary","View Config"],[gt]]]],F={id:"home",match:["home"]},vt={router:{useFragment:!0,defaultRouteID:F.id,routes:[F]},events:{[Ke]:xe("debug",t=>t^1),[_]:[(t,[e,s])=>({[h]:[L,["keyState",s]]})],[E]:[(t,[e,s])=>({[h]:[p,["keyState",s]]})],[Z]:[()=>({[h]:[E,D]})],[q]:[()=>({[h]:[E,[...I(12,W([!0,!1],[.5,.5]))]]})],[G]:[(t,[e,s])=>({[h]:[p,["highlights",s]]})],[X]:[()=>({[h]:[G,[]]})],[J]:[()=>({[h]:[p,["size",[window.innerWidth,window.innerHeight]]]})],[Q]:[(t,[e,s])=>({[h]:[L,["viewConfig",s]]})],[ee]:[(t,[e,s])=>({[h]:[[L,"enabledMidi"],[p,["midiDevices",s]]]})],[v]:[(t,[e,s])=>({[h]:[[p,["midiFile",s]]]})],[te]:[()=>({[h]:[v,"INVALID MIDI FILE..."],[Fe]:[ze,[500,"DROP MIDI/AUDIO FILE HERE..."],v,v]})],[je]:[(t,[e,s])=>({[h]:[[p,["comparison",s]]]})]},effects:{},components:{[F.id]:pt},domRoot:"app",initialState:{enabledMidi:!1,midiDevices:[],midiFile:"DROP MIDI/AUDIO FILE HERE...",keyState:D,highlights:[],size:[window.innerWidth,window.innerHeight],viewConfig:{showMinor:!0,showSmall:!0},route:{},debug:1},views:{enabledMidi:"enabledMidi",midiDevices:"midiDevices",midiFile:"midiFile",keyState:"keyState",highlights:"highlights",size:"size",viewConfig:"viewConfig",json:["",t=>JSON.stringify(t,null,2)],debug:"debug"},ui:{root:{class:"clearfix flex flex-row font-sans m-0"},midiDevicesStatus:{content:[{class:"gray-500 p-1 bg-red-200 rounded-full"},{class:"gray-500 p-1 bg-green-200 rounded-full"}],dropdown:{root:{class:"ml-2 rounded-full nm-flat-gray-200 p-2 font-medium uppercase"},selection:{class:"bg-transparent font-medium uppercase"}}},toolbar:{root:{class:"my-4"},button:{class:"cursor-pointer mr-3 px-8 py-2 text-md font-medium nm-flat-gray-200 hover:nm-flat-gray-200-lg active:nm-inset-gray-200-sm rounded-full uppercase transition duration-200 ease-in-out transform"}},toggleGroup:{root:{class:""},key:{major:{class:"inline-block cursor-pointer nm-flat-gray-200 hover:nm-flat-gray-200-lg active:nm-inset-gray-200-lg rounded-full"},e:{class:"inline-block cursor-pointer nm-flat-gray-200 hover:nm-flat-gray-200-lg active:nm-inset-gray-200-lg rounded-full mr-8"},minor:{class:"inline-block cursor-pointer nm-flat-gray-200 hover:nm-flat-gray-200-lg active:nm-inset-gray-200-lg rounded-full mb-8"}}},keyGroup:{root:{class:"inline-block"},block:{class:"my-2 mr-2"}},fileDropZone:{root:{class:"mt-2 mb-8 border-dotted border-2 inline-block p-8 text-center font-medium nm-flat-gray-200-lg"}},code:{class:"m-0 ml-8 p-2 text-xs bg-gray-100 font-mono overflow-x-hidden"},column:{content:[{class:"float-left w-full m-4"},{class:"float-left w-5/6 m-4"}],debug:[{class:"float-right m-4 close"},{class:"float-right m-4 open"}]},debugToggle:{class:"toggle cursor-pointer tracking-wider"},viewConfigToggleGroup:{block:{class:"cursor-pointer my-2 flex justify-start items-center"},caption:{class:"ml-2"}}}};new We(vt).start();
